<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Flujo Creativo Grid</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <style>
      :root {
        --bg: #f7f6f4;
        --card: #ffffff;
        --radius: 26px;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        background: var(--bg);
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      }
      .toolbar {
        display: flex;
        gap: 14px;
        padding: 14px 16px 4px;
        background: var(--bg);
      }
      .btn-pill {
        width: 54px;
        height: 54px;
        border-radius: 20px;
        border: none;
        background: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        cursor: pointer;
        box-shadow: 0 5px 20px rgba(0,0,0,0.03);
      }
      .btn-primary {
        background: #151515;
        color: #fff;
        width: auto;
        padding: 0 18px;
        gap: 6px;
      }
      .filters-row {
        display: flex;
        gap: 10px;
        padding: 0 16px 10px;
      }
      .filters-row select {
        border: none;
        background: #fff;
        border-radius: 16px;
        padding: 6px 12px;
        font-size: 13px;
        outline: none;
      }
      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(110px, 1fr));
        gap: 6px;
        padding: 0 16px 30px;
      }
      .cell {
        background: #d7d7d7;
        aspect-ratio: 1 / 1;
        border-radius: 18px;
        overflow: hidden;
        position: relative;
        cursor: pointer;
      }
      .cell img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
      }
      .cell-empty {
        display: flex;
        align-items: center;
        justify-content: center;
        color: #858585;
        font-size: 11px;
      }
      .pin {
        position: absolute;
        top: 6px;
        right: 6px;
        width: 24px;
        height: 24px;
        border-radius: 999px;
        background: rgba(0,0,0,0.35);
        display: flex;
        align-items: center;
        justify-content: center;
        color: #fff;
        font-size: 14px;
      }
      .error-box {
        margin: 0 16px 10px;
        background: rgba(192,57,43,0.08);
        border: 1px solid rgba(192,57,43,0.2);
        border-radius: 14px;
        padding: 8px 12px;
        font-size: 12px;
        color: #a93226;
      }
      /* modal */
      .modal-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.35);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 100;
      }
      .modal {
        background: #fff;
        border-radius: 24px;
        max-width: 420px;
        width: calc(100% - 36px);
        max-height: calc(100% - 36px);
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }
      .modal-img {
        width: 100%;
        aspect-ratio: 1 / 1;
        background: #ccc;
      }
      .modal-img img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .modal-body {
        padding: 14px 16px 16px;
      }
      .modal-title {
        font-weight: 600;
        font-size: 14px;
      }
      .modal-meta {
        font-size: 12px;
        color: #777;
        margin-top: 4px;
      }
      .modal-close {
        position: absolute;
        top: 10px;
        right: 10px;
        background: rgba(255,255,255,0.8);
        border: none;
        border-radius: 999px;
        width: 28px;
        height: 28px;
        cursor: pointer;
      }
      @media (min-width: 900px) {
        .grid {
          grid-template-columns: repeat(3, minmax(200px, 1fr));
        }
      }
    </style>
  </head>
  <body>
    <div class="toolbar">
      <button class="btn-pill btn-primary" id="refreshBtn">Refresh</button>
      <button class="btn-pill" id="filtersBtn">‚öôÔ∏è</button>
      <button class="btn-pill">‚ãØ</button>
    </div>

    <!-- filtros visibles (desktop) -->
    <div class="filters-row" id="filtersRow">
      <select id="clientsSelect">
        <option value="all">All Clients</option>
      </select>
      <select id="projectsSelect">
        <option value="all">All Projects</option>
      </select>
      <select id="platformsSelect">
        <option value="all">All Platforms</option>
      </select>
      <select id="ownersSelect">
        <option value="all">All Owners</option>
      </select>
      <select id="statusesSelect">
        <option value="all">All Status</option>
      </select>
    </div>

    <div id="errorBox" class="error-box" style="display:none;"></div>

    <div class="grid" id="grid"></div>

    <!-- modal -->
    <div class="modal-backdrop" id="modalBackdrop">
      <div class="modal">
        <button class="modal-close" id="modalClose">‚úï</button>
        <div class="modal-img" id="modalImgBox"></div>
        <div class="modal-body">
          <div class="modal-title" id="modalTitle"></div>
          <div class="modal-meta" id="modalMeta"></div>
        </div>
      </div>
    </div>

    <script>
      const clientsSelect = document.getElementById("clientsSelect");
      const projectsSelect = document.getElementById("projectsSelect");
      const platformsSelect = document.getElementById("platformsSelect");
      const ownersSelect = document.getElementById("ownersSelect");
      const statusesSelect = document.getElementById("statusesSelect");
      const grid = document.getElementById("grid");
      const errorBox = document.getElementById("errorBox");
      const refreshBtn = document.getElementById("refreshBtn");
      const filtersBtn = document.getElementById("filtersBtn");

      const modalBackdrop = document.getElementById("modalBackdrop");
      const modalImgBox = document.getElementById("modalImgBox");
      const modalTitle = document.getElementById("modalTitle");
      const modalMeta = document.getElementById("modalMeta");
      const modalClose = document.getElementById("modalClose");

      let ALL_FILTERS = {
        clients: [],
        projects: [],
        platforms: [],
        owners: [],
        statuses: [],
      };

      let CURRENT_FILTERS = {
        clientId: "all",
        projectId: "all",
        platformId: "all",
        ownerId: "all",
        statusId: "all",
      };

      let LAST_POSTS = [];

      async function init() {
        await loadFilters();
        await loadPosts();
      }

      async function loadFilters() {
        try {
          const r = await fetch("/api/filters");
          const data = await r.json();
          if (!data.ok) {
            showError(data.error || "Error al cargar filtros");
            return;
          }
          hideError();
          ALL_FILTERS = data.filters;

          fillSelect(clientsSelect, ALL_FILTERS.clients, "All Clients");
          fillSelect(projectsSelect, ALL_FILTERS.projects, "All Projects", { skipEmptyName: true });
          fillSelect(platformsSelect, ALL_FILTERS.platforms, "All Platforms");
          fillSelect(ownersSelect, ALL_FILTERS.owners, "All Owners");
          fillSelect(statusesSelect, ALL_FILTERS.statuses, "All Status");
        } catch (err) {
          showError("Error al cargar filtros: " + err.message);
        }
      }

      async function loadPosts() {
        try {
          grid.innerHTML = "";
          const qs = new URLSearchParams(CURRENT_FILTERS).toString();
          const r = await fetch("/api/grid?" + qs);
          const data = await r.json();
          if (!data.ok) {
            showError(data.error || "Error al cargar los posts");
            return;
          }
          hideError();
          LAST_POSTS = data.posts || [];
          renderGrid(LAST_POSTS);
        } catch (err) {
          showError("Error al cargar posts: " + err.message);
        }
      }

      function renderGrid(posts) {
        if (!posts.length) {
          grid.innerHTML = "<p style='font-size:12px;color:#777;'>No content</p>";
          return;
        }
        grid.innerHTML = "";
        posts.forEach((post) => {
          const cell = document.createElement("div");
          cell.className = "cell";

          if (post.mediaUrl) {
            const img = document.createElement("img");
            img.src = post.mediaUrl;
            img.alt = post.title;
            cell.appendChild(img);
          } else {
            const empty = document.createElement("div");
            empty.className = "cell-empty";
            empty.textContent = "No image";
            cell.appendChild(empty);
          }

          if (post.pinned) {
            const pin = document.createElement("div");
            pin.className = "pin";
            pin.textContent = "üìå";
            cell.appendChild(pin);
          }

          cell.addEventListener("click", () => openModal(post));
          grid.appendChild(cell);
        });
      }

      function fillSelect(selectEl, items, firstLabel, { skipEmptyName = false } = {}) {
        selectEl.innerHTML = "";
        const o = document.createElement("option");
        o.value = "all";
        o.textContent = firstLabel;
        selectEl.appendChild(o);

        (items || []).forEach((item) => {
          if (skipEmptyName && (!item.name || item.name === "Sin nombre")) return;
          const opt = document.createElement("option");
          opt.value = item.id;
          opt.textContent = item.name;
          selectEl.appendChild(opt);
        });
      }

      // cascada
      clientsSelect.addEventListener("change", () => {
        const clientId = clientsSelect.value;
        CURRENT_FILTERS.clientId = clientId;

        if (clientId === "all") {
          fillSelect(projectsSelect, ALL_FILTERS.projects, "All Projects", { skipEmptyName: true });
          CURRENT_FILTERS.projectId = "all";
        } else {
          const filtered = (ALL_FILTERS.projects || []).filter(
            (p) => p.client_id === clientId && p.name && p.name !== "Sin nombre"
          );
          fillSelect(projectsSelect, filtered, "All Projects", { skipEmptyName: true });
          CURRENT_FILTERS.projectId = "all";
        }

        loadPosts();
      });

      projectsSelect.addEventListener("change", () => {
        CURRENT_FILTERS.projectId = projectsSelect.value;
        loadPosts();
      });

      platformsSelect.addEventListener("change", () => {
        CURRENT_FILTERS.platformId = platformsSelect.value;
        loadPosts();
      });

      ownersSelect.addEventListener("change", () => {
        CURRENT_FILTERS.ownerId = ownersSelect.value;
        loadPosts();
      });

      statusesSelect.addEventListener("change", () => {
        CURRENT_FILTERS.statusId = statusesSelect.value;
        loadPosts();
      });

      refreshBtn.addEventListener("click", async () => {
        await loadFilters();
        await loadPosts();
      });

      // modal
      function openModal(post) {
        modalBackdrop.style.display = "flex";
        modalImgBox.innerHTML = "";
        if (post.mediaUrl) {
          const img = document.createElement("img");
          img.src = post.mediaUrl;
          modalImgBox.appendChild(img);
        } else {
          modalImgBox.textContent = "No image";
        }
        modalTitle.textContent = post.title || "Untitled";
        const meta = [];
        if (post.date) meta.push(post.date);
        if (post.platforms && post.platforms.length) meta.push(post.platforms.join(", "));
        if (post.status) meta.push(post.status);
        if (post.owners && post.owners.length) meta.push("By " + post.owners.join(", "));
        modalMeta.textContent = meta.join(" ‚Ä¢ ");
      }
      function closeModal() {
        modalBackdrop.style.display = "none";
      }
      modalClose.addEventListener("click", closeModal);
      modalBackdrop.addEventListener("click", (e) => {
        if (e.target === modalBackdrop) closeModal();
      });

      // mostrar/ocultar filtros si lo quieres tipo modal en mobile
      filtersBtn.addEventListener("click", () => {
        const row = document.getElementById("filtersRow");
        row.style.display = row.style.display === "none" ? "flex" : "none";
      });

      function showError(msg) {
        errorBox.style.display = "block";
        errorBox.textContent = msg;
      }
      function hideError() {
        errorBox.style.display = "none";
        errorBox.textContent = "";
      }

      init();
    </script>
  </body>
</html>

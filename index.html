<script>
// ====== 1. REFERENCIAS A LOS SELECTS QUE YA TIENES ======
const selClient  = document.getElementById('selClient')  || document.getElementById('client-filter');
const selProject = document.getElementById('selProject') || document.getElementById('project-filter');
const selPlatform= document.getElementById('selPlatform')|| document.getElementById('platform-filter');
const selStatus  = document.getElementById('selStatus')  || document.getElementById('status-filter');
const ownerPanel = document.getElementById('owner-options'); // si aún no tienes esto, no pasa nada

// ====== 2. FUNCIÓN NUEVA: TRAER /api/filters ======
async function loadFilters() {
  let data;
  try {
    const res = await fetch('/api/filters');
    data = await res.json();
  } catch (err) {
    console.warn('No pude leer /api/filters', err);
    return;
  }

  // estructura esperada:
  // { clients: [{name,count}], projects: [...], platforms: [...], owners: [...] }

  // --- CLIENTES ---
  if (selClient) {
    selClient.innerHTML = ''; // limpiar
    const optAll = document.createElement('option');
    optAll.value = '';
    optAll.textContent = 'All Clients';
    selClient.appendChild(optAll);

    (data.clients || []).forEach(item => {
      const opt = document.createElement('option');
      opt.value = item.name;
      // si no hay nombre, no lo mostramos
      if (!item.name) return;
      opt.textContent = `${item.name} (${item.count || 0})`;
      selClient.appendChild(opt);
    });
  }

  // --- PROJECTS ---
  if (selProject) {
    selProject.innerHTML = '';
    const optAll = document.createElement('option');
    optAll.value = '';
    optAll.textContent = 'All Projects';
    selProject.appendChild(optAll);

    (data.projects || []).forEach(item => {
      if (!item.name) return;
      const opt = document.createElement('option');
      opt.value = item.name;
      opt.textContent = `${item.name} (${item.count || 0})`;
      selProject.appendChild(opt);
    });
  }

  // --- PLATFORMS ---
  if (selPlatform) {
    selPlatform.innerHTML = '';
    const optAll = document.createElement('option');
    optAll.value = '';
    optAll.textContent = 'All Platforms';
    selPlatform.appendChild(optAll);

    (data.platforms || []).forEach(name => {
      const opt = document.createElement('option');
      opt.value = name;
      opt.textContent = name;
      selPlatform.appendChild(opt);
    });
  }

  // --- STATUS ---
  if (selStatus) {
    selStatus.innerHTML = '';
    // opción 1: published only
    const optPub = document.createElement('option');
    optPub.value = 'published';
    optPub.textContent = 'Published only';
    selStatus.appendChild(optPub);
    // opción 2: all status
    const optAll = document.createElement('option');
    optAll.value = '';
    optAll.textContent = 'All Status';
    selStatus.appendChild(optAll);
  }

  // --- OWNERS (panel colapsable) ---
  if (ownerPanel && Array.isArray(data.owners)) {
    ownerPanel.innerHTML = '';
    data.owners.forEach((o, idx) => {
      const row = document.createElement('label');
      row.className = 'owner-option';
      row.innerHTML = `
        <input type="checkbox" name="owner" value="${o.name}">
        <span class="owner-badge" style="background:${o.color || '#666'}">${(o.initials || o.name?.slice(0,2) || '??').toUpperCase()}</span>
        <span class="owner-name">${o.name}</span>
        <span class="owner-count">(${o.count || 0})</span>
      `;
      ownerPanel.appendChild(row);
    });
  }
}

// ====== 3. LLAMAR A TODO AL INICIO ======
async function bootstrap() {
  // 1) primero filtros
  await loadFilters();
  // 2) luego posts
  await fetchPosts();
  buildOptions?.(); // si tenías esta función antes
  applyFilters?.();
}

// si ya tenías un bootstrap declarado, reemplaza su contenido por este.
// si no tenías, deja este:
bootstrap().catch(err => console.error(err));
</script>

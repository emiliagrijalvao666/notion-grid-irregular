<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Posts</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link rel="stylesheet" href="/styles.css" />
    <style>
      body {
        background: #f4f4f4;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        margin: 0;
        padding: 0;
      }
      .topbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 28px 28px 0;
      }
      .filters-row {
        display: flex;
        gap: 14px;
        padding: 12px 28px 24px;
      }
      select {
        border: none;
        background: #fff;
        border-radius: 999px;
        padding: 10px 16px;
        font-size: 14px;
        outline: none;
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      }
      .refresh-btn {
        background: #111;
        color: #fff;
        border: none;
        border-radius: 999px;
        padding: 10px 20px;
        font-size: 14px;
        cursor: pointer;
      }
      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 16px;
        padding: 0 28px 40px;
      }
      .card {
        background: #fff;
        border-radius: 20px;
        min-height: 180px;
        display: flex;
        flex-direction: column;
        justify-content: flex-end;
        overflow: hidden;
      }
      .card-thumb {
        flex: 1;
        background: #dfe4ea;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #aaa;
        font-size: 12px;
      }
      .card-footer {
        padding: 10px 14px 14px;
      }
      .card-title {
        font-weight: 600;
        font-size: 14px;
      }
      .card-date {
        font-size: 12px;
        color: #777;
        margin-top: 4px;
      }
      .error-box {
        color: #c0392b;
        background: rgba(192, 57, 43, 0.12);
        border: 1px solid rgba(192, 57, 43, 0.25);
        padding: 10px 16px;
        border-radius: 14px;
        margin: 0 28px 18px;
        font-size: 13px;
      }
    </style>
  </head>
  <body>
    <div class="topbar">
      <h1 style="margin:0;font-size:34px;">Posts</h1>
      <button class="refresh-btn" id="refreshBtn">Refresh</button>
    </div>

    <div class="filters-row">
      <select id="clientsSelect">
        <option value="all">All Clients</option>
      </select>
      <select id="projectsSelect">
        <option value="all">All Projects</option>
      </select>
      <select id="platformsSelect">
        <option value="all">All Platforms</option>
      </select>
      <select id="ownersSelect">
        <option value="all">All Owners</option>
      </select>
      <select id="statusesSelect">
        <option value="all">All Status</option>
      </select>
    </div>

    <div id="errorBox" class="error-box" style="display:none;"></div>

    <div class="grid" id="postsGrid">
      <!-- cards -->
    </div>

    <script>
      const clientsSelect = document.getElementById("clientsSelect");
      const projectsSelect = document.getElementById("projectsSelect");
      const platformsSelect = document.getElementById("platformsSelect");
      const ownersSelect = document.getElementById("ownersSelect");
      const statusesSelect = document.getElementById("statusesSelect");
      const postsGrid = document.getElementById("postsGrid");
      const errorBox = document.getElementById("errorBox");
      const refreshBtn = document.getElementById("refreshBtn");

      // estado en memoria
      let ALL_FILTERS = {
        clients: [],
        projects: [],
        platforms: [],
        owners: [],
        statuses: [],
      };

      let CURRENT_FILTERS = {
        clientId: "all",
        projectId: "all",
        platformId: "all",
        ownerId: "all",
        statusId: "all",
      };

      async function init() {
        await loadFilters();
        await loadPosts();
      }

      async function loadFilters() {
        try {
          const resp = await fetch("/api/filters");
          const data = await resp.json();
          if (!data.ok) {
            showError(data.error || "No se pudieron cargar los filtros");
            return;
          }
          hideError();
          ALL_FILTERS = data.filters || ALL_FILTERS;

          // Clients
          fillSelect(clientsSelect, ALL_FILTERS.clients, "All Clients");

          // Projects (lista completa; luego filtramos si eligen client)
          fillSelect(projectsSelect, ALL_FILTERS.projects, "All Projects", {
            skipEmptyName: true,
          });

          // Platforms
          fillSelect(platformsSelect, ALL_FILTERS.platforms, "All Platforms");

          // Owners
          fillSelect(ownersSelect, ALL_FILTERS.owners, "All Owners");

          // Status
          fillSelect(statusesSelect, ALL_FILTERS.statuses, "All Status");
        } catch (err) {
          showError("Error inicial: " + err.message);
        }
      }

      function fillSelect(selectEl, items, firstLabel, { skipEmptyName = false } = {}) {
        // limpiar
        selectEl.innerHTML = "";
        const opt = document.createElement("option");
        opt.value = "all";
        opt.textContent = firstLabel;
        selectEl.appendChild(opt);

        (items || []).forEach((item) => {
          if (skipEmptyName && (!item.name || item.name === "Sin nombre")) {
            return;
          }
          const o = document.createElement("option");
          o.value = item.id;
          o.textContent = item.name;
          selectEl.appendChild(o);
        });
      }

      async function loadPosts() {
        try {
          postsGrid.innerHTML = "Cargando...";
          const qs = new URLSearchParams(CURRENT_FILTERS).toString();
          const resp = await fetch("/api/grid?" + qs);
          const data = await resp.json();
          if (!data.ok) {
            showError(data.error || "No se pudieron cargar los posts");
            postsGrid.innerHTML = "";
            return;
          }
          hideError();
          renderPosts(data.posts || []);
        } catch (err) {
          showError("Error al cargar posts: " + err.message);
          postsGrid.innerHTML = "";
        }
      }

      function renderPosts(posts) {
        if (!posts.length) {
          postsGrid.innerHTML = "<p>No posts</p>";
          return;
        }
        postsGrid.innerHTML = "";
        posts.forEach((post) => {
          const card = document.createElement("div");
          card.className = "card";

          const thumb = document.createElement("div");
          thumb.className = "card-thumb";
          if (post.attachments && post.attachments.length > 0) {
            // mostramos solo "image" texto, no cargamos la imagen real para no pesar
            thumb.textContent = "image";
          } else {
            thumb.textContent = "No image";
          }

          const footer = document.createElement("div");
          footer.className = "card-footer";
          const title = document.createElement("div");
          title.className = "card-title";
          title.textContent = post.title;
          const date = document.createElement("div");
          date.className = "card-date";
          date.textContent = post.date ? post.date : "";

          footer.appendChild(title);
          footer.appendChild(date);

          card.appendChild(thumb);
          card.appendChild(footer);

          postsGrid.appendChild(card);
        });
      }

      // Cascada: cuando cambia CLIENT â†’ proyectos se filtran
      clientsSelect.addEventListener("change", () => {
        const clientId = clientsSelect.value;
        CURRENT_FILTERS.clientId = clientId;
        // rearmar projects
        if (clientId === "all") {
          fillSelect(projectsSelect, ALL_FILTERS.projects, "All Projects", { skipEmptyName: true });
          CURRENT_FILTERS.projectId = "all";
        } else {
          const filtered = (ALL_FILTERS.projects || []).filter(
            (p) => p.client_id === clientId && p.name && p.name !== "Sin nombre"
          );
          fillSelect(projectsSelect, filtered, "All Projects", { skipEmptyName: true });
          CURRENT_FILTERS.projectId = "all";
        }
        loadPosts();
      });

      projectsSelect.addEventListener("change", () => {
        CURRENT_FILTERS.projectId = projectsSelect.value;
        loadPosts();
      });

      platformsSelect.addEventListener("change", () => {
        CURRENT_FILTERS.platformId = platformsSelect.value;
        loadPosts();
      });

      ownersSelect.addEventListener("change", () => {
        CURRENT_FILTERS.ownerId = ownersSelect.value;
        loadPosts();
      });

      statusesSelect.addEventListener("change", () => {
        CURRENT_FILTERS.statusId = statusesSelect.value;
        loadPosts();
      });

      refreshBtn.addEventListener("click", async () => {
        await loadFilters();
        await loadPosts();
      });

      function showError(msg) {
        errorBox.style.display = "block";
        errorBox.textContent = msg;
      }
      function hideError() {
        errorBox.style.display = "none";
        errorBox.textContent = "";
      }

      init();
    </script>
  </body>
</html>

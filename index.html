<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Posts</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      body {
        margin: 0;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        background: #f6f6f6;
      }
      header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 24px 32px 8px;
      }
      h1 {
        margin: 0;
        font-size: 2.3rem;
      }
      .filters {
        display: flex;
        gap: 12px;
        padding: 0 32px 16px;
      }
      select {
        background: #fff;
        border: none;
        border-radius: 9999px;
        padding: 10px 22px;
        font-size: 0.9rem;
        box-shadow: 0 2px 8px rgba(15, 23, 42, 0.05);
        outline: none;
      }
      button.refresh {
        background: #fff;
        border: none;
        border-radius: 9999px;
        padding: 10px 18px;
        cursor: pointer;
        box-shadow: 0 2px 8px rgba(15, 23, 42, 0.05);
      }
      .error {
        background: #fee2e2;
        color: #b91c1c;
        margin: 0 32px 16px;
        padding: 12px 16px;
        border-radius: 12px;
        font-size: 0.85rem;
      }
      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
        gap: 16px;
        padding: 0 32px 32px;
      }
      .card {
        background: #fff;
        border-radius: 18px;
        overflow: hidden;
        min-height: 180px;
        display: flex;
        flex-direction: column;
        box-shadow: 0 2px 8px rgba(15, 23, 42, 0.04);
      }
      .thumb {
        background: #e2e8f0;
        height: 140px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.7rem;
        color: #475569;
      }
      .thumb img {
        width: 100%;
        height: 140px;
        object-fit: cover;
        display: block;
      }
      .card-body {
        padding: 10px 14px 14px;
      }
      .title {
        font-weight: 600;
        font-size: 0.9rem;
        margin-bottom: 4px;
      }
      .meta {
        font-size: 0.7rem;
        color: #64748b;
      }
      @media (max-width: 640px) {
        header,
        .filters {
          flex-wrap: wrap;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <h1>Posts</h1>
      <button class="refresh" id="refreshBtn">Refresh</button>
    </header>

    <div class="filters">
      <select id="clientSelect">
        <option value="all">All Clients</option>
      </select>

      <select id="projectSelect">
        <option value="all">All Projects</option>
      </select>

      <select id="platformSelect">
        <option value="all">All Platforms</option>
      </select>

      <select id="ownerSelect">
        <option value="all">All Owners</option>
      </select>

      <select id="statusSelect">
        <option value="all">All Status</option>
      </select>
    </div>

    <div id="errorBox" class="error" style="display: none"></div>

    <div class="grid" id="postsGrid">
      <!-- cards -->
    </div>

    <script>
      const clientSelect = document.getElementById("clientSelect");
      const projectSelect = document.getElementById("projectSelect");
      const platformSelect = document.getElementById("platformSelect");
      const ownerSelect = document.getElementById("ownerSelect");
      const statusSelect = document.getElementById("statusSelect");
      const postsGrid = document.getElementById("postsGrid");
      const errorBox = document.getElementById("errorBox");
      const refreshBtn = document.getElementById("refreshBtn");

      // guardamos aqu√≠ todos los projects con su clientId
      let ALL_PROJECTS = [];

      async function loadFilters() {
        try {
          const resp = await fetch("/api/filters");
          const data = await resp.json();

          if (!data.ok) {
            throw new Error(data.error || "Error al cargar filtros");
          }

          // 1) Clients
          clientSelect.innerHTML = `<option value="all">All Clients</option>`;
          data.filters.clients.forEach((c) => {
            const opt = document.createElement("option");
            opt.value = c.id;
            opt.textContent = c.name;
            clientSelect.appendChild(opt);
          });

          // 2) Projects (guardamos todo para filtrar por client luego)
          ALL_PROJECTS = data.filters.projects || [];
          renderProjectsForClient("all");

          // 3) Platforms
          platformSelect.innerHTML = `<option value="all">All Platforms</option>`;
          (data.filters.platforms || []).forEach((p) => {
            const opt = document.createElement("option");
            opt.value = p;
            opt.textContent = p;
            platformSelect.appendChild(opt);
          });

          // 4) Owners
          ownerSelect.innerHTML = `<option value="all">All Owners</option>`;
          (data.filters.owners || []).forEach((o) => {
            const opt = document.createElement("option");
            opt.value = o.id;
            opt.textContent = o.name;
            ownerSelect.appendChild(opt);
          });

          // 5) Status
          statusSelect.innerHTML = `<option value="all">All Status</option>`;
          (data.filters.statuses || []).forEach((s) => {
            const opt = document.createElement("option");
            opt.value = s;
            opt.textContent = s;
            statusSelect.appendChild(opt);
          });
        } catch (err) {
          showError("Error inicial: " + err.message);
        }
      }

      function renderProjectsForClient(clientId) {
        projectSelect.innerHTML = `<option value="all">All Projects</option>`;

        let list = ALL_PROJECTS;
        if (clientId !== "all") {
          list = ALL_PROJECTS.filter((p) => p.clientId === clientId);
        }

        list.forEach((p) => {
          const opt = document.createElement("option");
          opt.value = p.id;
          opt.textContent = p.name;
          projectSelect.appendChild(opt);
        });
      }

      async function loadPosts() {
        hideError();
        postsGrid.innerHTML = "Cargando...";

        const params = new URLSearchParams();
        params.set("client", clientSelect.value);
        params.set("project", projectSelect.value);
        params.set("platform", platformSelect.value);
        params.set("owner", ownerSelect.value);
        params.set("status", statusSelect.value);

        try {
          const resp = await fetch(`/api/grid?${params.toString()}`);
          const data = await resp.json();

          if (!data.ok) {
            throw new Error(data.error || "Error al cargar posts");
          }

          renderPosts(data.posts || []);
        } catch (err) {
          showError(err.message);
          postsGrid.innerHTML = "";
        }
      }

      function renderPosts(posts) {
        if (!posts.length) {
          postsGrid.innerHTML = "<p>No hay posts.</p>";
          return;
        }

        postsGrid.innerHTML = "";

        posts.forEach((post) => {
          const card = document.createElement("div");
          card.className = "card";

          const thumb = document.createElement("div");
          thumb.className = "thumb";
          if (post.image) {
            const img = document.createElement("img");
            img.src = post.image;
            thumb.appendChild(img);
          } else {
            thumb.textContent = "No image";
          }

          const body = document.createElement("div");
          body.className = "card-body";

          const title = document.createElement("div");
          title.className = "title";
          title.textContent = post.title;

          const meta = document.createElement("div");
          meta.className = "meta";
          const date = post.publishDate ? post.publishDate : "sin fecha";
          meta.textContent = date;

          body.appendChild(title);
          body.appendChild(meta);

          card.appendChild(thumb);
          card.appendChild(body);

          postsGrid.appendChild(card);
        });
      }

      function showError(msg) {
        errorBox.style.display = "block";
        errorBox.textContent = msg;
      }

      function hideError() {
        errorBox.style.display = "none";
        errorBox.textContent = "";
      }

      // eventos
      clientSelect.addEventListener("change", () => {
        // cuando cambias client, cambiamos projects
        renderProjectsForClient(clientSelect.value);
        loadPosts();
      });
      projectSelect.addEventListener("change", loadPosts);
      platformSelect.addEventListener("change", loadPosts);
      ownerSelect.addEventListener("change", loadPosts);
      statusSelect.addEventListener("change", loadPosts);
      refreshBtn.addEventListener("click", loadPosts);

      // init
      (async () => {
        await loadFilters();
        await loadPosts();
      })();
    </script>
  </body>
</html>

<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Content Grid</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root {
        --bg: #f2f1ee;
        --card: #ffffff;
        --soft: rgba(0, 0, 0, 0.04);
        --text: #1f2933;
        --muted: #8a8f99;
        --radius-lg: 20px;
        --radius-md: 14px;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        background: var(--bg);
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        color: var(--text);
      }
      .page {
        max-width: 1180px;
        margin: 0 auto;
        padding: 32px 20px 80px;
      }
      header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 16px;
        margin-bottom: 22px;
      }
      h1.title {
        font-size: 30px;
        font-weight: 700;
        letter-spacing: -0.01em;
      }
      .filters {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        margin-bottom: 18px;
      }
      select,
      button,
      input {
        border: none;
        outline: none;
        background: white;
        border-radius: 999px;
        padding: 7px 16px;
        font-size: 14px;
        line-height: 1.4;
        cursor: pointer;
      }
      select {
        background: #fff;
        border: 1px solid rgba(15, 23, 42, 0.05);
      }
      select:disabled {
        opacity: 0.4;
        cursor: default;
      }
      button#btnRefresh {
        background: #1f2933;
        color: #fff;
      }
      input#search {
        min-width: 160px;
        background: rgba(255, 255, 255, 0.3);
        border: 1px solid rgba(15, 23, 42, 0.05);
      }
      .grid {
        display: grid;
        gap: 14px;
        grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      }
      .card {
        background: #fff;
        border-radius: 18px;
        min-height: 150px;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        position: relative;
        border: 1px solid rgba(15, 23, 42, 0.02);
      }
      .thumb {
        background: #ececec;
        min-height: 100px;
        flex: 1;
        background-position: center;
        background-size: cover;
      }
      .no-image {
        display: flex;
        align-items: center;
        justify-content: center;
        color: #a0a5ad;
        font-size: 12px;
        background: linear-gradient(180deg, #f1f2f3 0%, #e5e6e7 100%);
      }
      .card-footer {
        padding: 9px 11px 11px;
        background: linear-gradient(180deg, rgba(242, 241, 238, 0) 0%, rgba(242, 241, 238, 0.69) 100%);
      }
      .card-title {
        font-size: 13px;
        font-weight: 500;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .card-meta {
        font-size: 11px;
        color: #9aa0a8;
      }
      .empty {
        margin-top: 30px;
        text-align: center;
        color: #9aa0a8;
      }
      .load-more {
        display: block;
        margin: 24px auto 0;
        background: #0f172a;
        color: white;
        border-radius: 999px;
        padding: 8px 18px;
        border: none;
        cursor: pointer;
      }
      @media (max-width: 720px) {
        header {
          flex-direction: column;
          align-items: flex-start;
        }
        .filters {
          width: 100%;
        }
        .grid {
          grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        }
      }
    </style>
  </head>
  <body>
    <div class="page">
      <header>
        <h1 class="title">Posts</h1>
        <div style="display:flex; gap:10px;">
          <button id="btnRefresh">Refresh</button>
          <input id="search" placeholder="Buscar..." />
        </div>
      </header>

      <div class="filters">
        <select id="selClient">
          <option value="">All Clients</option>
        </select>
        <select id="selProject">
          <option value="">All Projects</option>
        </select>
        <!-- brands fuera -->
        <select id="selPlatform">
          <option value="">All Platforms</option>
        </select>
        <select id="selOwner">
          <option value="">All Owners</option>
        </select>
        <select id="selStatus">
          <option value="">All Status</option>
        </select>
      </div>

      <div id="grid" class="grid"></div>
      <button id="btnMore" class="load-more" style="display:none;">Load more</button>
      <p id="empty" class="empty" style="display:none;">No hay posts</p>
    </div>

    <script>
      const gridEl = document.getElementById("grid");
      const emptyEl = document.getElementById("empty");
      const moreBtn = document.getElementById("btnMore");

      const selClient = document.getElementById("selClient");
      const selProject = document.getElementById("selProject");
      const selPlatform = document.getElementById("selPlatform");
      const selOwner = document.getElementById("selOwner");
      const selStatus = document.getElementById("selStatus");
      const searchInput = document.getElementById("search");

      let nextCursor = null;
      let currentFilters = {};

      // ---------- 1) Cargar filtros ----------
      async function loadFilters() {
        try {
          const res = await fetch("/api/filters");
          const data = await res.json();

          if (!data.ok) return;

          // CLIENTES
          if (Array.isArray(data.clients)) {
            data.clients.forEach((c) => {
              if (!c.name) return;
              const opt = document.createElement("option");
              opt.value = c.name;
              opt.textContent = c.name + (c.count ? ` (${c.count})` : "");
              selClient.appendChild(opt);
            });
          }

          // PROYECTOS
          if (Array.isArray(data.projects)) {
            data.projects.forEach((p) => {
              if (!p.name) return;
              const opt = document.createElement("option");
              opt.value = p.name;
              opt.textContent = p.name;
              selProject.appendChild(opt);
            });
          }

          // PLATAFORMAS
          if (Array.isArray(data.platforms)) {
            data.platforms.forEach((pl) => {
              const opt = document.createElement("option");
              opt.value = pl;
              opt.textContent = pl;
              selPlatform.appendChild(opt);
            });
          }

          // OWNERS
          if (Array.isArray(data.owners)) {
            data.owners.forEach((o) => {
              if (!o.name) return;
              const opt = document.createElement("option");
              opt.value = o.name;
              opt.textContent = o.name + (o.count ? ` (${o.count})` : "");
              selOwner.appendChild(opt);
            });
          }

          // STATUS
          if (Array.isArray(data.statuses) && data.statuses.length) {
            data.statuses.forEach((st) => {
              const opt = document.createElement("option");
              opt.value = st;
              opt.textContent = st;
              selStatus.appendChild(opt);
            });
          } else {
            // fallback a lo que ya tenÃ­as
            const optPub = document.createElement("option");
            optPub.value = "Published";
            optPub.textContent = "Published Only";
            selStatus.appendChild(optPub);
          }
        } catch (err) {
          console.warn("No se pudieron cargar los filtros:", err);
        }
      }

      // ---------- 2) Cargar posts ----------
      async function loadPosts(reset = true) {
        if (reset) {
          gridEl.innerHTML = "";
          emptyEl.style.display = "none";
          nextCursor = null;
        }

        const params = new URLSearchParams();

        // filtros actuales
        const client = selClient.value;
        const project = selProject.value;
        const platform = selPlatform.value;
        const owner = selOwner.value;
        const status = selStatus.value;
        const q = searchInput.value.trim();

        if (client) params.append("client", client);
        if (project) params.append("project", project);
        if (platform) params.append("platform", platform);
        if (owner) params.append("owner", owner);
        if (status) params.append("status", status);
        if (q) params.append("q", q);
        if (nextCursor) params.append("cursor", nextCursor);

        const res = await fetch("/api/grid?" + params.toString());
        const data = await res.json();

        if (!data.ok) {
          gridEl.innerHTML = "";
          emptyEl.style.display = "block";
          emptyEl.textContent = data.error || "Error cargando posts";
          moreBtn.style.display = "none";
          return;
        }

        const posts = data.posts || [];

        if (!posts.length && reset) {
          emptyEl.style.display = "block";
          moreBtn.style.display = "none";
          return;
        }

        posts.forEach((post) => {
          const card = document.createElement("div");
          card.className = "card";

          const thumb = document.createElement("div");
          thumb.className = "thumb";

          // intentamos sacar imagen
          let coverUrl = post.cover || post.image || post.thumbnail;
          if (!coverUrl && Array.isArray(post.files) && post.files.length) {
            coverUrl = post.files[0].url || post.files[0].file?.url;
          }

          if (coverUrl) {
            thumb.style.backgroundImage = `url(${coverUrl})`;
          } else {
            thumb.classList.add("no-image");
            thumb.textContent = "No image";
          }

          const footer = document.createElement("div");
          footer.className = "card-footer";

          const title = document.createElement("div");
          title.className = "card-title";
          title.textContent = post.title || post.name || "Untitled";

          const meta = document.createElement("div");
          meta.className = "card-meta";
          meta.textContent = post.publish_date || post.date || "";

          footer.appendChild(title);
          footer.appendChild(meta);

          card.appendChild(thumb);
          card.appendChild(footer);
          gridEl.appendChild(card);
        });

        // cursor para load more
        if (data.has_more && data.next_cursor) {
          nextCursor = data.next_cursor;
          moreBtn.style.display = "block";
        } else {
          nextCursor = null;
          moreBtn.style.display = "none";
        }
      }

      // ---------- events ----------
      selClient.addEventListener("change", () => loadPosts(true));
      selProject.addEventListener("change", () => loadPosts(true));
      selPlatform.addEventListener("change", () => loadPosts(true));
      selOwner.addEventListener("change", () => loadPosts(true));
      selStatus.addEventListener("change", () => loadPosts(true));
      document.getElementById("btnRefresh").addEventListener("click", () => loadPosts(true));
      moreBtn.addEventListener("click", () => loadPosts(false));
      searchInput.addEventListener("input", () => {
        // le damos 300ms si quieres, pero lo dejo directo
        loadPosts(true);
      });

      // ---------- init ----------
      (async function init() {
        await loadFilters();
        await loadPosts(true);
      })();
    </script>
  </body>
</html>

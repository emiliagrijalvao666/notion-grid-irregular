<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Posts</title>
  <link rel="stylesheet" href="/styles.css" />
</head>
<body>
  <header class="topbar">
    <h1 class="title">Posts <span id="count"></span></h1>
    <div class="actions">
      <button id="refreshBtn">Refresh</button>
      <input id="search" placeholder="Buscar..." />
    </div>
  </header>

  <section class="filters">
    <select id="fClient"><option value="">All Clients</option></select>
    <select id="fProject"><option value="">All Projects</option></select>
    <select id="fBrand"><option value="">All Brands</option></select>
    <select id="fPlatform"><option value="">All Platforms</option></select>
    <select id="fStatus">
      <option value="published" selected>Published Only</option>
      <option value="all">All Status</option>
    </select>
  </section>

  <main>
    <div id="grid" class="grid"></div>
    <div class="center">
      <button id="loadMore" style="display:none;">Load more</button>
    </div>
  </main>

  <!-- Modal -->
  <div id="modal" class="modal hidden" tabindex="-1">
    <div class="modal-backdrop"></div>
    <div class="modal-content">
      <button id="modalClose" class="modal-close" aria-label="Close">×</button>
      <div id="modalMedia" class="modal-media"></div>
      <div id="modalCopy" class="modal-copy"></div>
      <div id="modalInfo" class="modal-info"></div>
    </div>
  </div>

<script>
const state = {
  status: 'published',
  client: '', project: '', brand: '', platform: '', owner: '',
  q: '',
  limit: 12,
  offset: 0,
  total: 0
};

const els = {
  count: document.getElementById('count'),
  grid: document.getElementById('grid'),
  loadMore: document.getElementById('loadMore'),
  refresh: document.getElementById('refreshBtn'),
  search: document.getElementById('search'),
  fStatus: document.getElementById('fStatus'),
  fClient: document.getElementById('fClient'),
  fProject: document.getElementById('fProject'),
  fBrand: document.getElementById('fBrand'),
  fPlatform: document.getElementById('fPlatform'),
  modal: document.getElementById('modal'),
  modalClose: document.getElementById('modalClose'),
  modalMedia: document.getElementById('modalMedia'),
  modalCopy: document.getElementById('modalCopy'),
  modalInfo: document.getElementById('modalInfo')
};

function qs(obj) {
  const p = new URLSearchParams();
  if (obj.status) p.set('status', obj.status);
  if (obj.client) p.set('client', obj.client);
  if (obj.project) p.set('project', obj.project);
  if (obj.brand) p.set('brand', obj.brand);
  if (obj.platform) p.set('platform', obj.platform);
  if (obj.owner) p.set('owner', obj.owner);
  if (obj.q) p.set('q', obj.q);
  p.set('limit', obj.limit);
  p.set('offset', obj.offset);
  return p.toString();
}

function optionize(select, items, label = 'name') {
  // Mantiene "All ..." como primer option
  const first = select.querySelector('option');
  select.innerHTML = '';
  if (first) select.appendChild(first);
  (items || []).forEach(it => {
    const opt = document.createElement('option');
    const name = (typeof it === 'string') ? it : it.name;
    const count = (typeof it === 'object' && 'count' in it) ? it.count : null;
    opt.value = name;
    opt.textContent = count != null ? `${name} (${count})` : name;
    select.appendChild(opt);
  });
}

function card(post) {
  const div = document.createElement('div');
  div.className = 'card';
  div.tabIndex = 0;

  const img = document.createElement('div');
  img.className = 'thumb';
  const url = (post.assets && post.assets[0] && post.assets[0].url) ? post.assets[0].url : '';
  if (url) {
    img.style.backgroundImage = `url('${url}')`;
  } else {
    img.classList.add('thumb-empty');
    img.textContent = 'No image';
  }

  const title = document.createElement('div');
  title.className = 'card-title';
  title.textContent = post.title || 'Untitled';

  const footer = document.createElement('div');
  footer.className = 'card-footer';
  footer.textContent = (post.date || '').slice(0, 10);

  div.appendChild(img);
  div.appendChild(title);
  div.appendChild(footer);

  div.addEventListener('click', () => openModal(post));
  return div;
}

function openModal(post) {
  els.modalMedia.innerHTML = '';
  els.modalCopy.textContent = '';
  els.modalInfo.textContent = '';

  const url = (post.assets && post.assets[0] && post.assets[0].url) ? post.assets[0].url : '';
  if (url && /\.(mp4|mov|webm)$/i.test(url)) {
    const v = document.createElement('video');
    v.src = url; v.controls = true;
    els.modalMedia.appendChild(v);
  } else if (url) {
    const img = document.createElement('img');
    img.src = url; img.alt = post.title || '';
    els.modalMedia.appendChild(img);
  } else {
    const p = document.createElement('div');
    p.className = 'modal-noimg';
    p.textContent = 'No image';
    els.modalMedia.appendChild(p);
  }

  if (post.copy) {
    const box = document.createElement('div');
    box.className = 'copybox';
    box.textContent = post.copy;
    els.modalCopy.appendChild(box);
  }

  const info = [];
  if (post.title) info.push(post.title);
  const meta = [];
  if (post.date) meta.push(post.date.slice(0,10));
  if (post.clients && post.clients.length) meta.push(post.clients.join(', '));
  if (post.projectNames && post.projectNames.length) meta.push(post.projectNames.join(', '));
  if (meta.length) info.push('· ' + meta.join(' · '));
  els.modalInfo.textContent = info.join('\n');

  els.modal.classList.remove('hidden');
  els.modal.focus();
}
function closeModal() {
  els.modal.classList.add('hidden');
}
els.modalClose.addEventListener('click', closeModal);
document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal(); });
els.modal.addEventListener('click', (e) => {
  if (e.target === els.modal || e.target.classList.contains('modal-backdrop')) closeModal();
});

// Render y fetch
async function fetchPage(reset = false) {
  if (reset) {
    state.offset = 0;
    els.grid.innerHTML = '';
  }
  const url = `/api/grid?${qs({
    status: state.status,
    client: state.client,
    project: state.project,
    brand: state.brand,
    platform: state.platform,
    owner: state.owner,
    q: state.q,
    limit: state.limit,
    offset: state.offset
  })}`;

  const r = await fetch(url);
  const data = await r.json();
  if (!data.ok) {
    els.count.textContent = '';
    els.grid.innerHTML = `<div class="error">Error cargando posts</div>`;
    els.loadMore.style.display = 'none';
    return;
  }

  // Título contador
  state.total = data.total || 0;
  els.count.textContent = `(${state.total})`;

  // Dropdowns con contadores (orden DESC)
  if (state.offset === 0) {
    optionize(els.fClient, data.filters?.clients || []);
    optionize(els.fProject, data.filters?.projects || []);
    optionize(els.fBrand, data.filters?.brands || []);
    optionize(els.fPlatform, data.filters?.platforms || []);
  }

  // Cards
  (data.posts || []).forEach(p => els.grid.appendChild(card(p)));

  // Load more
  if (data.has_more) {
    state.offset = data.next_offset;
    els.loadMore.style.display = 'inline-flex';
  } else {
    els.loadMore.style.display = 'none';
  }
}

// Listeners
els.refresh.addEventListener('click', () => fetchPage(true));
els.search.addEventListener('input', (e) => { state.q = e.target.value || ''; fetchPage(true); });
els.fStatus.addEventListener('change', (e) => { state.status = e.target.value; fetchPage(true); });
els.fClient.addEventListener('change', (e) => { state.client = e.target.value; fetchPage(true); });
els.fProject.addEventListener('change', (e) => { state.project = e.target.value; fetchPage(true); });
els.fBrand.addEventListener('change', (e) => { state.brand = e.target.value; fetchPage(true); });
els.fPlatform.addEventListener('change', (e) => { state.platform = e.target.value; fetchPage(true); });
els.loadMore.addEventListener('click', () => fetchPage(false));

// Primer render
fetchPage(true);
</script>
</body>
</html>

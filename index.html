<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>IG Grid</title>
    <link rel="stylesheet" href="/styles.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
  </head>
  <body>
    <div class="app">
      <header class="topbar">
        <div class="topbar-left">
          <!-- sin "Posts" -->
        </div>
        <button id="refreshBtn" class="refresh-btn">Refresh</button>
      </header>

      <div class="filters-row">
        <select id="clientFilter" class="filter-pill">
          <option value="all">All Clients</option>
        </select>
        <select id="projectFilter" class="filter-pill">
          <option value="all">All Projects</option>
        </select>
        <select id="platformFilter" class="filter-pill">
          <option value="all">All Platforms</option>
        </select>
        <select id="ownerFilter" class="filter-pill">
          <option value="all">All Owners</option>
        </select>
        <select id="statusFilter" class="filter-pill">
          <option value="all">All Status</option>
        </select>
      </div>

      <div class="grid-wrapper">
        <div id="postsGrid" class="posts-grid">
          <div class="loading">Cargando‚Ä¶</div>
        </div>
      </div>

      <button id="loadMoreBtn" class="load-more">Load more</button>
    </div>

    <script>
      // estado
      let FILTER_DATA = {
        clients: [],
        projects: [],
        platforms: [],
        owners: [],
        statuses: [],
      };
      let CURRENT_FILTERS = {
        client: "all",
        project: "all",
        platform: "all",
        owner: "all",
        status: "all",
      };
      let PAGE_SIZE = 15;

      const clientSel = document.getElementById("clientFilter");
      const projectSel = document.getElementById("projectFilter");
      const platformSel = document.getElementById("platformFilter");
      const ownerSel = document.getElementById("ownerFilter");
      const statusSel = document.getElementById("statusFilter");
      const postsGrid = document.getElementById("postsGrid");
      const refreshBtn = document.getElementById("refreshBtn");
      const loadMoreBtn = document.getElementById("loadMoreBtn");

      async function loadFilters() {
        try {
          const resp = await fetch("/api/filters");
          const data = await resp.json();
          if (!data.ok) throw new Error(data.error);
          FILTER_DATA = data;

          // clients
          clientSel.innerHTML = '<option value="all">All Clients</option>';
          data.clients.forEach((c) => {
            const opt = document.createElement("option");
            opt.value = c.id;
            opt.textContent = c.name;
            clientSel.appendChild(opt);
          });

          // projects (todos, luego filtramos seg√∫n client)
          renderProjectsForClient("all");

          // platforms
          platformSel.innerHTML = '<option value="all">All Platforms</option>';
          data.platforms.forEach((p) => {
            const opt = document.createElement("option");
            opt.value = p.id;
            opt.textContent = p.name;
            platformSel.appendChild(opt);
          });

          // owners
          ownerSel.innerHTML = '<option value="all">All Owners</option>';
          data.owners.forEach((o) => {
            const opt = document.createElement("option");
            opt.value = o.id;
            opt.textContent = o.name;
            ownerSel.appendChild(opt);
          });

          // statuses
          statusSel.innerHTML = '<option value="all">All Status</option>';
          data.statuses.forEach((s) => {
            const opt = document.createElement("option");
            opt.value = s.id;
            opt.textContent = s.name;
            statusSel.appendChild(opt);
          });
        } catch (err) {
          console.error("Error cargando filtros:", err);
        }
      }

      function renderProjectsForClient(clientId) {
        projectSel.innerHTML = '<option value="all">All Projects</option>';
        const allProjects = FILTER_DATA.projects || [];
        const list =
          clientId === "all"
            ? allProjects
            : allProjects.filter((p) => p.clientIds?.includes(clientId));
        list.forEach((p) => {
          const opt = document.createElement("option");
          opt.value = p.id;
          opt.textContent = p.name || "Sin nombre";
          projectSel.appendChild(opt);
        });
      }

      async function loadPosts(reset = true) {
        if (reset) {
          postsGrid.innerHTML = '<div class="loading">Cargando‚Ä¶</div>';
        }

        const params = new URLSearchParams({
          client: CURRENT_FILTERS.client,
          project: CURRENT_FILTERS.project,
          platform: CURRENT_FILTERS.platform,
          owner: CURRENT_FILTERS.owner,
          status: CURRENT_FILTERS.status,
          pageSize: PAGE_SIZE.toString(),
        });

        const resp = await fetch("/api/grid?" + params.toString());
        const data = await resp.json();

        if (!data.ok) {
          postsGrid.innerHTML =
            '<div class="error">No se pudieron cargar los posts.</div>';
          return;
        }

        const { posts } = data;

        if (reset) postsGrid.innerHTML = "";

        if (!posts.length) {
          postsGrid.innerHTML =
            '<div class="no-content">No content</div>';
          return;
        }

        posts.forEach((post) => {
          const card = document.createElement("article");
          card.className = "post-card";

          const firstMedia = post.media?.[0];

          if (firstMedia) {
            card.style.backgroundImage = `url(${firstMedia.url})`;
          } else {
            card.classList.add("no-image");
            card.textContent = "No content";
          }

          // overlay info
          const overlay = document.createElement("div");
          overlay.className = "overlay";

          const title = document.createElement("div");
          title.className = "title";
          title.textContent = post.title;

          const date = document.createElement("div");
          date.className = "date";
          date.textContent = post.date ? post.date : "";

          overlay.appendChild(title);
          overlay.appendChild(date);

          // pin
          if (post.pinned) {
            const pin = document.createElement("div");
            pin.className = "pin-icon";
            pin.textContent = "üìå";
            card.appendChild(pin);
          }

          // video icon
          if (firstMedia && firstMedia.kind === "video") {
            const vid = document.createElement("div");
            vid.className = "video-icon";
            vid.textContent = "‚ñ∂";
            card.appendChild(vid);
          }

          // carrusel (si hay m√°s de 1 media)
          if (post.media && post.media.length > 1) {
            const car = document.createElement("div");
            car.className = "carousel-icon";
            car.textContent = "‚ãØ";
            card.appendChild(car);
          }

          card.appendChild(overlay);
          postsGrid.appendChild(card);
        });
      }

      // listeners
      clientSel.addEventListener("change", (e) => {
        const val = e.target.value;
        CURRENT_FILTERS.client = val;
        // actualizar projects seg√∫n client
        renderProjectsForClient(val);
        // y reset project
        CURRENT_FILTERS.project = "all";
        loadPosts(true);
      });

      projectSel.addEventListener("change", (e) => {
        CURRENT_FILTERS.project = e.target.value;
        loadPosts(true);
      });

      platformSel.addEventListener("change", (e) => {
        CURRENT_FILTERS.platform = e.target.value;
        loadPosts(true);
      });

      ownerSel.addEventListener("change", (e) => {
        CURRENT_FILTERS.owner = e.target.value;
        loadPosts(true);
      });

      statusSel.addEventListener("change", (e) => {
        CURRENT_FILTERS.status = e.target.value;
        loadPosts(true);
      });

      refreshBtn.addEventListener("click", () => {
        loadPosts(true);
      });

      loadMoreBtn.addEventListener("click", () => {
        PAGE_SIZE += 15;
        loadPosts(true);
      });

      // init
      (async function init() {
        await loadFilters();
        await loadPosts(true);
      })();
    </script>
  </body>
</html>

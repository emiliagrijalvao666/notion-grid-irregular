<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Posts</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="/styles.css" />
  </head>
  <body>
    <div class="topbar">
      <h1>Posts</h1>
      <button id="refresh-btn">Refresh</button>
    </div>

    <div class="filters">
      <select id="filter-clients"></select>
      <select id="filter-projects"></select>
      <select id="filter-platforms"></select>
      <select id="filter-owners"></select>
      <select id="filter-statuses"></select>
    </div>

    <div id="grid" class="grid">Cargando...</div>

    <script>
      let ALL_FILTERS = null; // guardamos acá lo que vino de /api/filters

      async function loadFilters() {
        const res = await fetch("/api/filters");
        const data = await res.json();
        if (!data.ok) {
          throw new Error(data.error || "Error cargando filtros");
        }
        ALL_FILTERS = data.filters;
      }

      function fillSelectFromArray(select, arr, isObjects = false) {
        select.innerHTML = "";
        arr.forEach((item) => {
          const opt = document.createElement("option");
          if (isObjects) {
            opt.value = item.id;
            opt.textContent =
              item.name && item.name.trim() !== "" ? item.name : item.id;
          } else {
            opt.value = item;
            opt.textContent = item;
          }
          select.appendChild(opt);
        });
      }

      function applyFiltersToUI() {
        const selClients = document.getElementById("filter-clients");
        const selProjects = document.getElementById("filter-projects");
        const selPlatforms = document.getElementById("filter-platforms");
        const selOwners = document.getElementById("filter-owners");
        const selStatuses = document.getElementById("filter-statuses");

        // clients (objetos)
        fillSelectFromArray(selClients, ALL_FILTERS.clients, true);
        // projects completos (objetos)
        fillSelectFromArray(selProjects, ALL_FILTERS.projects, true);
        // platforms (strings)
        fillSelectFromArray(selPlatforms, ALL_FILTERS.platforms, false);
        // owners (objetos)
        fillSelectFromArray(selOwners, ALL_FILTERS.owners, true);
        // statuses (strings)
        fillSelectFromArray(selStatuses, ALL_FILTERS.statuses, false);
      }

      // filtrar proyectos según el cliente elegido
      function updateProjectsForClient(clientId) {
        const selProjects = document.getElementById("filter-projects");
        if (!ALL_FILTERS) return;

        const allProjects = ALL_FILTERS.projects; // [{id,name,clientIds:[]}, ...]
        let projectsToShow = allProjects;

        if (clientId && clientId !== "all" && clientId !== "All Clients") {
          projectsToShow = allProjects.filter((p) => {
            // el proyecto "All Projects" no lo filtramos
            if (p.id === "all") return true;
            if (!p.clientIds || p.clientIds.length === 0) {
              // proyecto sin cliente: lo escondemos si hay cliente seleccionado
              return false;
            }
            return p.clientIds.includes(clientId);
          });
        }

        fillSelectFromArray(selProjects, projectsToShow, true);
      }

      async function loadPosts() {
        const grid = document.getElementById("grid");
        grid.innerHTML = "Cargando...";

        const selClients = document.getElementById("filter-clients");
        const selProjects = document.getElementById("filter-projects");
        const selPlatforms = document.getElementById("filter-platforms");
        const selOwners = document.getElementById("filter-owners");
        const selStatuses = document.getElementById("filter-statuses");

        const params = new URLSearchParams({
          client: selClients.value,
          project: selProjects.value,
          platform: selPlatforms.value,
          owner: selOwners.value,
          status: selStatuses.value,
        });

        const res = await fetch("/api/grid?" + params.toString());
        const data = await res.json();

        if (!data.ok) {
          grid.innerHTML = `<div class="error">${data.error}</div>`;
          return;
        }

        if (!data.posts || data.posts.length === 0) {
          grid.innerHTML = `<p>Sin posts</p>`;
          return;
        }

        grid.innerHTML = "";
        data.posts.forEach((post) => {
          const card = document.createElement("div");
          card.className = "card";
          card.innerHTML = `
            <div class="thumb">
              ${
                post.image
                  ? `<img src="${post.image}" alt="" />`
                  : `<div class="noimg">No image</div>`
              }
            </div>
            <div class="ctitle">${post.title}</div>
            <div class="cdate">${post.date || ""}</div>
          `;
          grid.appendChild(card);
        });
      }

      // listeners
      document.addEventListener("DOMContentLoaded", async () => {
        try {
          await loadFilters();
          applyFiltersToUI();
          await loadPosts();
        } catch (err) {
          document.getElementById("grid").innerHTML =
            "<p>Error inicial: " + err.message + "</p>";
        }

        const selClients = document.getElementById("filter-clients");
        const selProjects = document.getElementById("filter-projects");
        const selPlatforms = document.getElementById("filter-platforms");
        const selOwners = document.getElementById("filter-owners");
        const selStatuses = document.getElementById("filter-statuses");
        const refreshBtn = document.getElementById("refresh-btn");

        selClients.addEventListener("change", async () => {
          updateProjectsForClient(selClients.value);
          await loadPosts();
        });
        selProjects.addEventListener("change", loadPosts);
        selPlatforms.addEventListener("change", loadPosts);
        selOwners.addEventListener("change", loadPosts);
        selStatuses.addEventListener("change", loadPosts);
        refreshBtn.addEventListener("click", loadPosts);
      });
    </script>
  </body>
</html>

<script>
  const state = {
    client: "All Clients",
    project: "All Projects",
    platform: "All Platforms",
    owner: "All Owners",
    status: "All Status",
  };

  const $clients   = document.querySelector('#filter-clients');
  const $projects  = document.querySelector('#filter-projects');
  const $platforms = document.querySelector('#filter-platforms');
  const $owners    = document.querySelector('#filter-owners');
  const $status    = document.querySelector('#filter-status');
  const $refresh   = document.querySelector('#refresh-btn');
  const $grid      = document.querySelector('#posts-grid');

  async function loadData() {
    const qs = new URLSearchParams(state).toString();
    const res = await fetch(`/api/grid?${qs}`);
    const data = await res.json();
    if (!data.ok) {
      console.error(data);
      return;
    }

    // 1) Pinta dropdowns (evita [object Object]: todo es .name string)
    fillSelect($clients,  "All Clients",   data.filters.clients);
    fillSelect($projects, "All Projects",  data.filters.projects);
    fillSelect($platforms,"All Platforms", data.filters.platforms);
    fillSelect($owners,   "All Owners",    data.filters.owners);
    fillSelect($status,   "All Status",    data.filters.statuses);

    // Mantén selección previa si existe en el set
    keepValueOrDefault($clients,  state.client,  "All Clients");
    keepValueOrDefault($projects, state.project, "All Projects");
    keepValueOrDefault($platforms,state.platform,"All Platforms");
    keepValueOrDefault($owners,   state.owner,   "All Owners");
    keepValueOrDefault($status,   state.status,  "All Status");

    // 2) Pinta grid
    renderGrid(data.posts || []);
  }

  function fillSelect($el, defaultLabel, arr) {
    const html = [
      `<option>${defaultLabel}</option>`,
      ...(arr || []).map(x => `<option value="${escapeHtml(x.name)}">${escapeHtml(x.name)}</option>`),
    ].join("");
    $el.innerHTML = html;
  }

  function keepValueOrDefault($el, val, def) {
    const has = Array.from($el.options).some(o => o.value === val);
    $el.value = has ? val : def;
  }

  function renderGrid(posts) {
    $grid.innerHTML = posts.map(cardHTML).join("") || `<div style="opacity:.6">No hay posts</div>`;
  }

  function cardHTML(p) {
    const img = p.attachment
      ? `<img src="${p.attachment}" alt="${escapeHtml(p.title)}" style="width:100%;height:120px;object-fit:cover;" />`
      : `<div style="width:100%;height:120px;background:#e9e9e9;display:flex;align-items:center;justify-content:center;color:#999">No image</div>`;

    const date = p.publishDate ? `<div style="font-size:.75rem;color:#666">${p.publishDate}</div>` : "";
    const clients = p.clients?.length ? `<div style="font-size:.75rem;color:#444">${p.clients.join(", ")}</div>` : "";

    const pin = p.pinned
      ? `<span style="position:absolute;top:6px;right:6px;background:#111;color:#fff;font-size:.65rem;border-radius:999px;padding:2px 6px">Pinned</span>`
      : "";

    return `
      <article style="background:#f6f6f6;border-radius:16px;overflow:hidden;position:relative;min-height:160px">
        ${img}
        ${pin}
        <div style="padding:.75rem">
          <div style="font-weight:600">${escapeHtml(p.title || "Untitled")}</div>
          ${date}
          ${clients}
        </div>
      </article>
    `;
  }

  function escapeHtml(s) {
    return (s || "").replace(/[&<>"']/g, (m) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
  }

  // eventos
  $clients.addEventListener('change',  () => { state.client  = $clients.value;  loadData(); });
  $projects.addEventListener('change', () => { state.project = $projects.value; loadData(); });
  $platforms.addEventListener('change',() => { state.platform= $platforms.value;loadData(); });
  $owners.addEventListener('change',   () => { state.owner   = $owners.value;   loadData(); });
  $status.addEventListener('change',   () => { state.status  = $status.value;   loadData(); });
  $refresh.addEventListener('click',   () => { loadData(); });

  // primera carga
  loadData();
</script>
